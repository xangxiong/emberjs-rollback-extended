/**
 * MIT License
 *
 * Copyright (c) 2017 Xang Xiong
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * @version 1.0.0
 */
!function(e,i){"function"==typeof define&&define.amd?define(["ember","jquery"],function(e,t){return i(e,t)}):i(Ember,$)}(this,function(e,i){return e.Mixin.create({isDirty:!1,_deepRelationships:null,_shallowRelationships:null,_originalRelationships:null,_dirtyRelationships:null,_activeObservers:null,_activity:null,onInit:function(){var i=this
this.set("_deepRelationships",e.A()),this.set("_shallowRelationships",e.A()),this.set("_originalRelationships",e.Object.create()),this.set("_dirtyRelationships",e.A()),this.set("_activeObservers",e.Object.create()),this.set("_activity",e.Object.create({rollingback:!1,saving:!1,deleting:!1,unloading:!1})),this.eachRelationship(function(e,t){t.options&&t.options.cascade&&t.options.cascade.persist===!0?i.get("_deepRelationships").addObject(e):i.get("_shallowRelationships").addObject(e)}),e.run.once(this,function(){this._captureRelationships(),this._startObservers()})}.on("init"),observerEnabled:function(){return this.performingActivity("rollingback")===!1}.property("_activity.rollingback"),hasDirtyRelationships:function(){return this.get("_dirtyRelationships").length>0}.property("_dirtyRelationships.[]"),isDeepRelationship:function(e){return this.get("_deepRelationships").includes(e)},performingActivity:function(e){return this.get("_activity").get(e)===!0},startActivity:function(e){this.get("_activity").set(e,!0)},endActivity:function(e){this.get("_activity").set(e,!1)},rollback:function(){var e=this
this.startActivity("rollingback"),this.get("_shallowRelationships").forEach(function(i){var t=e.relationshipFor(i)
if("belongsTo"===t.kind){var s=e.belongsTo(i);(t.options.async===!1||s.belongsToRelationship.hasLoaded)&&e._rollbackBelongsTo(i,!1,t.options&&t.options.cascade&&t.options.cascade.remove)}else if("hasMany"===t.kind){var n=e.hasMany(i);(t.options.async===!1||n.hasManyRelationship.hasLoaded)&&e._rollbackHasMany(i,!1,t.options&&t.options.cascade&&t.options.cascade.remove)}e.get("_dirtyRelationships").removeObject(i)}),this.get("_deepRelationships").forEach(function(i){var t=e.relationshipFor(i)
if("belongsTo"===t.kind){var s=e.belongsTo(i);(t.options.async===!1||s.belongsToRelationship.hasLoaded)&&e._rollbackBelongsTo(i,!0,t.options&&t.options.cascade&&t.options.cascade.remove)}else if("hasMany"===t.kind){var n=e.hasMany(i);(t.options.async===!1||n.hasManyRelationship.hasLoaded)&&e._rollbackHasMany(i,!0,t.options&&t.options.cascade&&t.options.cascade.remove)}e.get("_dirtyRelationships").removeObject(i)}),this.rollbackAttributes(),this.endActivity("rollingback")},undeleteRecord:function(){var e=this.get("currentState")
e&&"root.deleted.uncommitted"==e.stateName&&e.rolledBack(this._internalModel)},_rollbackBelongsTo:function(e,i,t){var s=this.relationshipFor(e)
i=i||!1
var n=this.get(e)
s.options.async!==!1&&n&&(n=n.get("content"))
var o=void 0
n&&(n.get("isDirty")&&!n.performingActivity("rollingback")&&(i?n.rollback():t&&n.get("isDeleted")&&n.undeleteRecord()),o=n.get("id"))
var a=this.get("_originalRelationships").get(e)
if(a){if(a!=o){var r=this.store.peekRecord(s.type,a)
r?(r.get("isDirty")&&!r.performingActivity("rollingback")&&(i?r.rollback():t&&r.get("isDeleted")&&r.undeleteRecord()),this.set(e,r)):this.set(e,void 0)}}else this.set(e,void 0)},_rollbackHasMany:function(i,t,s){var n=this,o=this.relationshipFor(i)
t=t||!1
var a=this.get(i)
o.options.async!==!1&&a&&(a=a.get("content")),a&&a.toArray().forEach(function(e){e&&!e.performingActivity("rollingback")&&(t?e.rollback():s&&e.get("isDeleted")&&e.undeleteRecord())})
var r=this.get("_originalRelationships").get(i)
if(!e.isEqual(r.join(","),a.sortBy("id").mapBy("id").join(","))){var h=[]
r.forEach(function(e){var i=n.store.peekRecord(o.type,e)
i&&(i.get("isDirty")&&!i.performingActivity("rollingback")&&(t?i.rollback():s&&i.get("isDeleted")&&i.undeleteRecord()),h.pushObject(i))}),this.set(i,h)}},_captureRelationships:function(){var e=this
this.eachRelationship(function(i,t){if("belongsTo"===t.kind)if(e.get("_originalRelationships").set(i,void 0),t.options.async!==!1){var s=e.belongsTo(i)
if(s.belongsToRelationship.hasLoaded)e.get(i).then(function(t){t=t?t.get("id"):void 0,e.get("_originalRelationships").set(i,t)})
else{var n=s.belongsToRelationship.setHasLoaded
s.belongsToRelationship.setHasLoaded=function(t){s.belongsToRelationship.setHasLoaded=n,s.belongsToRelationship.setHasLoaded(t),e.get(i).then(function(t){t=t?t.get("id"):void 0,e.get("_originalRelationships").set(i,t)})}}}else{var o=e.get(i)
o=o?o.get("id"):void 0,e.get("_originalRelationships").set(i,o)}else if("hasMany"===t.kind)if(e.get("_originalRelationships").set(i,[]),t.options.async!==!1){var a=e.hasMany(i)
if(a.hasManyRelationship.hasLoaded)e.get(i).then(function(t){e.get("_originalRelationships").set(i,t.without(void 0).sortBy("id").mapBy("id"))})
else{var n=a.hasManyRelationship.setHasLoaded
a.hasManyRelationship.setHasLoaded=function(t){a.hasManyRelationship.setHasLoaded=n,a.hasManyRelationship.setHasLoaded(t),e.get(i).then(function(t){e.get("_originalRelationships").set(i,t.without(void 0).sortBy("id").mapBy("id"))})}}}else e.get("_originalRelationships").set(i,e.get(i).without(void 0).sortBy("id").mapBy("id"))})},set:function(e,t){var s=this
if(!this.get("isLoaded"))return this._super.apply(this,arguments)
var n=this.relationshipFor(e)
if(!n)return this._super.apply(this,arguments)
var o=this.get(e)
this.isDeepRelationship(e)&&(n.options.async!==!1?!o||o.get("isFulfilled")&&o.get("content")!==t?this._removeKeyObserver(e):i.when(o).then(function(i){i!==t&&s._removeKeyObserver(e)}):o!==t&&this._removeKeyObserver(e))
var a=this._super.apply(this,arguments)
return"belongsTo"===n.kind?this._belongsToDirtyChecker(e,this):"hasMany"===n.kind&&this._hasManyDirtyChecker(e,this),this.isDeepRelationship(e)&&(n.options.async!==!1?!o||o.get("isFulfilled")&&o.get("content")!==t?this._initializeObserver(e,n):i.when(o).then(function(i){i!==t&&s._initializeObserver(e,n)}):o!==t&&this._initializeObserver(e,n)),a},save:function(i){var t=this
this.startActivity("saving")
var s=[]
return this.get("_deepRelationships").forEach(function(e){var i=t.relationshipFor(e)
if("belongsTo"===i.kind){var n=t.belongsTo(e)
if(i.options.async===!1||n.belongsToRelationship.hasLoaded){var o=t.get(e)
o&&(i.options.async!==!1&&(o=o.get("content")),o&&o.get("isDirty")&&!o.performingActivity("saving")&&s.push(o.save()))}}else if("hasMany"===i.kind){var a=t.hasMany(e)
if(i.options.async===!1||a.hasManyRelationship.hasLoaded){var r=t.get(e)
r&&(i.options.async!==!1&&(r=r.get("content")),r.forEach(function(e){e&&e.get("isDirty")&&!e.performingActivity("saving")&&s.push(e.save())}))}}}),s.push(this._super.apply(this,arguments)),new e.RSVP.Promise(function(i,n){e.RSVP.Promise.all(s).then(function(){t.set("_dirtyRelationships",e.A()),t.set("_originalRelationships",e.Object.create()),t.set("isDirty",!1),t._captureRelationships(),t.endActivity("saving"),i()},function(e){t.endActivity("saving"),n(e)})})},deleteRecord:function(){var e=this
this.startActivity("deleting"),this._super.apply(this,arguments),this.eachRelationship(function(i,t){if(t.options&&t.options.cascade&&t.options.cascade.remove===!0)if("belongsTo"==t.kind){var s=e.belongsTo(i)
if(t.options.async===!1||s.belongsToRelationship.hasLoaded){var n=e.get(i)
n&&(t.options.async!==!1&&(n=n.get("content")),!n||n.performingActivity("deleting")||n.get("isDeleted")||n.deleteRecord())}}else if("hasMany"==t.kind){var o=e.hasMany(i)
if(t.options.async===!1||o.hasManyRelationship.hasLoaded){var a=e.get(i)
a&&(t.options.async!==!1&&(a=a.get("content")),a.toArray().forEach(function(e){!e||e.performingActivity("deleting")||e.get("isDeleted")||e.deleteRecord()}))}}},this),this.endActivity("deleting")},unloadRecord:function(){var e=this
this.startActivity("unloading"),this.eachRelationship(function(i,t){if(t.options&&t.options.cascade&&t.options.cascade.remove===!0)if("belongsTo"==t.kind){var s=e.belongsTo(i)
if(t.options.async===!1||s.belongsToRelationship.hasLoaded){var n=e.get(i)
n&&(t.options.async!==!1&&(n=n.get("content")),!n||n.performingActivity("unloading")||n.get("isDestroyed")||n.unloadRecord())}}else if("hasMany"==t.kind){var o=e.hasMany(i)
if(t.options.async===!1||o.hasManyRelationship.hasLoaded){var a=e.get(i)
a&&(t.options.async!==!1&&(a=a.get("content")),a.toArray().forEach(function(e){!e||e.performingActivity("unloading")||e.get("isDestroyed")||e.unloadRecord()}))}}},this),this._super.apply(this,arguments),this.endActivity("unloading")},_addKeyObserver:function(e,t,s,n){this.get("_activeObservers").get(e)&&this._removeKeyObserver(e),n=i.proxy(n,this,e),t=t||this,t.addObserver(s,n),this.get("_activeObservers").set(e,[t,s,n])},_removeKeyObserver:function(e){var i=this.get("_activeObservers").get(e)
i&&i.length>3&&i[0].removeObserver(i[1],i[2]),this.get("_activeObservers").set(e,void 0)},_belongsToDirtyChecker:function(i,t){var s=this
if(this.get("observerEnabled")){var n=function(t){if(s.isDeepRelationship(i)&&t&&t.get("isDirty"))return void(s.get("_dirtyRelationships").includes(i)||s.get("_dirtyRelationships").addObject(i))
var n=t?t.get("id"):void 0
e.isEqual(n,s.get("_originalRelationships."+i))?s.get("_dirtyRelationships").removeObject(i):s.get("_dirtyRelationships").includes(i)||s.get("_dirtyRelationships").addObject(i)},o=this.get(i)
n(this.relationshipFor(i).options.async!==!1?o.get("content"):o)}},_hasManyDirtyChecker:function(i,t){var s=this
if(this.get("observerEnabled")){var n=function(t){if(s.isDeepRelationship(i)){var n=s.get(i).without(void 0).filterBy("isDirty",!0).sortBy("id").mapBy("id")
if(n=null===n||void 0===n?[]:n,n.length>0)return void(s.get("_dirtyRelationships").includes(i)||s.get("_dirtyRelationships").addObject(i))}var o=t.without(void 0).filterBy("isDeleted",!1).sortBy("id").mapBy("id")
o=o||[]
var a=s.get("_originalRelationships").get(i)
a=a||[],e.isEqual(o.join(","),a.join(","))?s.get("_dirtyRelationships").removeObject(i):s.get("_dirtyRelationships").includes(i)||s.get("_dirtyRelationships").addObject(i)},o=this.get(i)
n(this.relationshipFor(i).options.async!==!1?o.get("content"):o)}},_startObservers:function(){var e=this,i=function(){e.set("isDirty",e.get("hasDirtyAttributes")||e.get("hasDirtyRelationships")||e.get("isDeleted")||e.get("isNew"))}
this.addObserver("currentState.isDirty",i),this.addObserver("_dirtyRelationships.[]",i),this.addObserver("isDeleted",i),this.addObserver("isNew",i),this.eachRelationship(function(i,t){e._initializeObserver(i,t)})},_initializeObserver:function(e,i){var t=this
if("belongsTo"===i.kind){if(t.isDeepRelationship(e))if(i.options.async!==!1){var s=t.belongsTo(e)
if(s.belongsToRelationship.hasLoaded)t._addKeyObserver(e,t.get(e),"content.isDirty",t._belongsToDirtyChecker)
else{var n=s.belongsToRelationship.setHasLoaded
s.belongsToRelationship.setHasLoaded=function(i){s.belongsToRelationship.setHasLoaded=n,s.belongsToRelationship.setHasLoaded(i),t._addKeyObserver(e,t.get(e),"content.isDirty",t._belongsToDirtyChecker)}}}else t._addKeyObserver(e,t,e+".isDirty",t._belongsToDirtyChecker)}else if("hasMany"===i.kind){var o=t.hasMany(e)
if(i.options.async!==!1){var a=e
if(a=t.isDeepRelationship(e)?"content.@each.isDirty":"content.[]",o.hasManyRelationship.hasLoaded)t._addKeyObserver(e,t.get(e),a,t._hasManyDirtyChecker)
else{var n=o.hasManyRelationship.setHasLoaded
o.hasManyRelationship.setHasLoaded=function(i){o.hasManyRelationship.setHasLoaded=n,o.hasManyRelationship.setHasLoaded(i),t._addKeyObserver(e,t.get(e),a,t._hasManyDirtyChecker)}}}else t.isDeepRelationship(e)?t._addKeyObserver(e,t,e+".@each.isDirty",t._hasManyDirtyChecker):t._addKeyObserver(e,t,e+".[]",t._hasManyDirtyChecker)}}})})
