/**
 * MIT License
 *
 * Copyright (c) 2017 Xang Xiong
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * @version 1.1.0
 */
!function(i,e){"function"==typeof define&&define.amd?define(["ember","jquery"],function(i,t){return e(i,t)}):e(Ember,$)}(this,function(i,e){return i.Mixin.create({isDirty:!1,_deepRelationships:null,_shallowRelationships:null,_originalRelationships:null,_dirtyRelationships:null,_activeObservers:null,_activity:null,onInit:function(){var e=this
this.set("_deepRelationships",i.A()),this.set("_shallowRelationships",i.A()),this.set("_originalRelationships",i.Object.create()),this.set("_dirtyRelationships",i.A()),this.set("_activeObservers",i.Object.create()),this.set("_activity",i.Object.create({rollingback:!1,saving:!1,deleting:!1,unloading:!1})),this.eachRelationship(function(i,t){t.options&&t.options.cascade&&t.options.cascade.persist===!0?e.get("_deepRelationships").addObject(i):e.get("_shallowRelationships").addObject(i)}),i.run.once(this,function(){this._captureRelationships(),this._startObservers()})}.on("init"),observerEnabled:function(){return this.performingActivity("rollingback")===!1}.property("_activity.rollingback"),hasDirtyRelationships:function(){return this.get("_dirtyRelationships").length>0}.property("_dirtyRelationships.[]"),isDeepRelationship:function(i){return this.get("_deepRelationships").includes(i)},performingActivity:function(i){return this.get("_activity").get(i)===!0},startActivity:function(i){this.get("_activity").set(i,!0)},endActivity:function(i){this.get("_activity").set(i,!1)},rollback:function(){var i=this
this.startActivity("rollingback"),this.get("_shallowRelationships").forEach(function(e){var t=i.relationshipFor(e),s=t.options&&t.options.cascade&&t.options.cascade.remove
if("belongsTo"===t.kind){var n=i.belongsTo(e);(t.options.async===!1||n.belongsToRelationship.hasLoaded)&&i._rollbackBelongsTo(e,!1,s)}else if("hasMany"===t.kind){var o=i.hasMany(e);(t.options.async===!1||o.hasManyRelationship.hasLoaded)&&i._rollbackHasMany(e,!1,s)}i.get("_dirtyRelationships").removeObject(e)}),this.get("_deepRelationships").forEach(function(e){var t=i.relationshipFor(e),s=t.options&&t.options.cascade&&t.options.cascade.remove
if("belongsTo"===t.kind){var n=i.belongsTo(e);(t.options.async===!1||n.belongsToRelationship.hasLoaded)&&i._rollbackBelongsTo(e,!0,s)}else if("hasMany"===t.kind){var o=i.hasMany(e);(t.options.async===!1||o.hasManyRelationship.hasLoaded)&&i._rollbackHasMany(e,!0,s)}i.get("_dirtyRelationships").removeObject(e)}),this.rollbackAttributes(),this.endActivity("rollingback")},undeleteRecord:function(){var i=this.get("currentState")
i&&"root.deleted.uncommitted"==i.stateName&&i.rolledBack(this._internalModel)},_rollbackBelongsTo:function(i,e,t){var s=this.relationshipFor(i)
e=e||!1
var n=this.get(i)
s.options.async!==!1&&n&&(n=n.get("content"))
var o=void 0
n&&(n.get("isDirty")&&!n.performingActivity("rollingback")&&(e?n.rollback():t&&n.get("isDeleted")&&n.undeleteRecord()),o=n.get("id"))
var a=this.get("_originalRelationships").get(i)
if(a){if(a!=o){var r=this.store.peekRecord(s.type,a)
r?(r.get("isDirty")&&!r.performingActivity("rollingback")&&(e?r.rollback():t&&r.get("isDeleted")&&r.undeleteRecord()),this.set(i,r)):this.set(i,void 0)}}else this.set(i,void 0)},_rollbackHasMany:function(e,t,s){var n=this,o=this.relationshipFor(e)
t=t||!1
var a=this.get(e)
o.options.async!==!1&&a&&(a=a.get("content")),a&&a.toArray().forEach(function(i){i&&!i.performingActivity("rollingback")&&(t?i.rollback():s&&i.get("isDeleted")&&i.undeleteRecord())})
var r=this.get("_originalRelationships").get(e)
if(!i.isEqual(r.join(","),a.sortBy("id").mapBy("id").join(","))){var h=[]
r.forEach(function(i){var e=n.store.peekRecord(o.type,i)
e&&(e.get("isDirty")&&!e.performingActivity("rollingback")&&(t?e.rollback():s&&e.get("isDeleted")&&e.undeleteRecord()),h.pushObject(e))}),this.set(e,h)}},_captureRelationships:function(){var i=this
this.eachRelationship(function(e,t){if("belongsTo"===t.kind)if(i.get("_originalRelationships").set(e,void 0),t.options.async!==!1){var s=i.belongsTo(e)
if(s.belongsToRelationship.hasLoaded)i.get(e).then(function(t){t=t?t.get("id"):void 0,i.get("_originalRelationships").set(e,t)})
else{var n=s.belongsToRelationship.setHasLoaded
s.belongsToRelationship.setHasLoaded=function(t){s.belongsToRelationship.setHasLoaded=n,s.belongsToRelationship.setHasLoaded(t),i.get(e).then(function(t){t=t?t.get("id"):void 0,i.get("_originalRelationships").set(e,t)})}}}else{var o=i.get(e)
o=o?o.get("id"):void 0,i.get("_originalRelationships").set(e,o)}else if("hasMany"===t.kind)if(i.get("_originalRelationships").set(e,[]),t.options.async!==!1){var a=i.hasMany(e)
if(a.hasManyRelationship.hasLoaded)i.get(e).then(function(t){i.get("_originalRelationships").set(e,t.without(void 0).sortBy("id").mapBy("id"))})
else{var n=a.hasManyRelationship.setHasLoaded
a.hasManyRelationship.setHasLoaded=function(t){a.hasManyRelationship.setHasLoaded=n,a.hasManyRelationship.setHasLoaded(t),i.get(e).then(function(t){i.get("_originalRelationships").set(e,t.without(void 0).sortBy("id").mapBy("id"))})}}}else i.get("_originalRelationships").set(e,i.get(e).without(void 0).sortBy("id").mapBy("id"))})},set:function(i,t){var s=this
if(!this.get("isLoaded"))return this._super.apply(this,arguments)
var n=this.relationshipFor(i)
if(!n)return this._super.apply(this,arguments)
var o=this.get(i)
this.isDeepRelationship(i)&&(n.options.async!==!1?!o||o.get("isFulfilled")&&o.get("content")!==t?this._removeKeyObserver(i):e.when(o).then(function(e){e!==t&&s._removeKeyObserver(i)}):o!==t&&this._removeKeyObserver(i))
var a=this._super.apply(this,arguments)
return"belongsTo"===n.kind?this._belongsToDirtyChecker(i,this):"hasMany"===n.kind&&this._hasManyDirtyChecker(i,this),this.isDeepRelationship(i)&&(n.options.async!==!1?!o||o.get("isFulfilled")&&o.get("content")!==t?this._initializeObserver(i,n):e.when(o).then(function(e){e!==t&&s._initializeObserver(i,n)}):o!==t&&this._initializeObserver(i,n)),a},saveAttributes:function(){return this.save({adapterOptions:{ignoreRelationships:!0}})},save:function(e){var t=this
if(this.startActivity("saving"),e&&e.adapterOptions&&e.adapterOptions.ignoreRelationships===!0){var s=this._super.apply(this,arguments)
return new i.RSVP.Promise(function(e,n){i.RSVP.Promise.resolve(s).then(function(){0==t.get("_dirtyRelationships").length&&t.set("isDirty",!1),t.endActivity("saving"),e()},function(i){t.endActivity("saving"),n(i)})})}var n=[]
return this.get("_deepRelationships").forEach(function(i){var e=t.relationshipFor(i)
if("belongsTo"===e.kind){var s=t.belongsTo(i)
if(e.options.async===!1||s.belongsToRelationship.hasLoaded){var o=t.get(i)
o&&(e.options.async!==!1&&(o=o.get("content")),o&&o.get("isDirty")&&!o.performingActivity("saving")&&n.push(o.save()))}}else if("hasMany"===e.kind){var a=t.hasMany(i)
if(e.options.async===!1||a.hasManyRelationship.hasLoaded){var r=t.get(i)
r&&(e.options.async!==!1&&(r=r.get("content")),r.forEach(function(i){i&&i.get("isDirty")&&!i.performingActivity("saving")&&n.push(i.save())}))}}}),n.push(this._super.apply(this,arguments)),new i.RSVP.Promise(function(e,s){i.RSVP.Promise.all(n).then(function(){t.set("_dirtyRelationships",i.A()),t.set("_originalRelationships",i.Object.create()),t.set("isDirty",!1),t._captureRelationships(),t.endActivity("saving"),e()},function(i){t.endActivity("saving"),s(i)})})},deleteRecord:function(){var i=this
this.startActivity("deleting"),this._super.apply(this,arguments),this.eachRelationship(function(e,t){if(t.options&&t.options.cascade&&t.options.cascade.remove===!0)if("belongsTo"==t.kind){var s=i.belongsTo(e)
if(t.options.async===!1||s.belongsToRelationship.hasLoaded){var n=i.get(e)
n&&(t.options.async!==!1&&(n=n.get("content")),!n||n.performingActivity("deleting")||n.get("isDeleted")||n.deleteRecord())}}else if("hasMany"==t.kind){var o=i.hasMany(e)
if(t.options.async===!1||o.hasManyRelationship.hasLoaded){var a=i.get(e)
a&&(t.options.async!==!1&&(a=a.get("content")),a.toArray().forEach(function(i){!i||i.performingActivity("deleting")||i.get("isDeleted")||i.deleteRecord()}))}}},this),this.endActivity("deleting")},unloadRecord:function(){var i=this
this.startActivity("unloading"),this.eachRelationship(function(e,t){if(t.options&&t.options.cascade&&t.options.cascade.remove===!0)if("belongsTo"==t.kind){var s=i.belongsTo(e)
if(t.options.async===!1||s.belongsToRelationship.hasLoaded){var n=i.get(e)
n&&(t.options.async!==!1&&(n=n.get("content")),!n||n.performingActivity("unloading")||n.get("isDestroyed")||n.unloadRecord())}}else if("hasMany"==t.kind){var o=i.hasMany(e)
if(t.options.async===!1||o.hasManyRelationship.hasLoaded){var a=i.get(e)
a&&(t.options.async!==!1&&(a=a.get("content")),a.toArray().forEach(function(i){!i||i.performingActivity("unloading")||i.get("isDestroyed")||i.unloadRecord()}))}}},this),this._super.apply(this,arguments),this.endActivity("unloading")},_addKeyObserver:function(i,t,s,n){this.get("_activeObservers").get(i)&&this._removeKeyObserver(i),n=e.proxy(n,this,i),t=t||this,t.addObserver(s,n),this.get("_activeObservers").set(i,[t,s,n])},_removeKeyObserver:function(i){var e=this.get("_activeObservers").get(i)
e&&e.length>3&&e[0].removeObserver(e[1],e[2]),this.get("_activeObservers").set(i,void 0)},_belongsToDirtyChecker:function(e,t){var s=this
if(this.get("observerEnabled")){var n=function(t){if(s.isDeepRelationship(e)&&t&&t.get("isDirty"))return void(s.get("_dirtyRelationships").includes(e)||s.get("_dirtyRelationships").addObject(e))
var n=t?t.get("id"):void 0
i.isEqual(n,s.get("_originalRelationships."+e))?s.get("_dirtyRelationships").removeObject(e):s.get("_dirtyRelationships").includes(e)||s.get("_dirtyRelationships").addObject(e)},o=this.get(e)
n(this.relationshipFor(e).options.async!==!1?o.get("content"):o)}},_hasManyDirtyChecker:function(e,t){var s=this
if(this.get("observerEnabled")){var n=function(t){if(s.isDeepRelationship(e)){var n=s.get(e).without(void 0).filterBy("isDirty",!0).sortBy("id").mapBy("id")
if(n=null===n||void 0===n?[]:n,n.length>0)return void(s.get("_dirtyRelationships").includes(e)||s.get("_dirtyRelationships").addObject(e))}var o=t.without(void 0).filterBy("isDeleted",!1).sortBy("id").mapBy("id")
o=o||[]
var a=s.get("_originalRelationships").get(e)
a=a||[],i.isEqual(o.join(","),a.join(","))?s.get("_dirtyRelationships").removeObject(e):s.get("_dirtyRelationships").includes(e)||s.get("_dirtyRelationships").addObject(e)},o=this.get(e)
n(this.relationshipFor(e).options.async!==!1?o.get("content"):o)}},_startObservers:function(){var i=this,e=function(){i.set("isDirty",i.get("hasDirtyAttributes")||i.get("hasDirtyRelationships")||i.get("isDeleted")||i.get("isNew"))}
this.addObserver("currentState.isDirty",e),this.addObserver("_dirtyRelationships.[]",e),this.addObserver("isDeleted",e),this.addObserver("isNew",e),this.eachRelationship(function(e,t){i._initializeObserver(e,t)})},_initializeObserver:function(i,e){var t=this
if("belongsTo"===e.kind){if(t.isDeepRelationship(i))if(e.options.async!==!1){var s=t.belongsTo(i)
if(s.belongsToRelationship.hasLoaded)t._addKeyObserver(i,t.get(i),"content.isDirty",t._belongsToDirtyChecker)
else{var n=s.belongsToRelationship.setHasLoaded
s.belongsToRelationship.setHasLoaded=function(e){s.belongsToRelationship.setHasLoaded=n,s.belongsToRelationship.setHasLoaded(e),t._addKeyObserver(i,t.get(i),"content.isDirty",t._belongsToDirtyChecker)}}}else t._addKeyObserver(i,t,i+".isDirty",t._belongsToDirtyChecker)}else if("hasMany"===e.kind){var o=t.hasMany(i)
if(e.options.async!==!1){var a=i
if(a=t.isDeepRelationship(i)?"content.@each.isDirty":"content.[]",o.hasManyRelationship.hasLoaded)t._addKeyObserver(i,t.get(i),a,t._hasManyDirtyChecker)
else{var n=o.hasManyRelationship.setHasLoaded
o.hasManyRelationship.setHasLoaded=function(e){o.hasManyRelationship.setHasLoaded=n,o.hasManyRelationship.setHasLoaded(e),t._addKeyObserver(i,t.get(i),a,t._hasManyDirtyChecker)}}}else t.isDeepRelationship(i)?t._addKeyObserver(i,t,i+".@each.isDirty",t._hasManyDirtyChecker):t._addKeyObserver(i,t,i+".[]",t._hasManyDirtyChecker)}}})})
